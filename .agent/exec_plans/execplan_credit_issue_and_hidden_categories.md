# ExecPlan: Улучшение выдачи кредита и скрытые категории

## Context and Orientation
- Цель: добавить выбор счета для зачисления кредита или отметку «кредит уже выдан», чтобы кредитный счет получал отрицательный баланс; скрывать категории, создаваемые при создании кредита, на экране категорий и в форме добавления/редактирования транзакций.
- Область кода: `lib/features/credits/`, `lib/features/categories/`, `lib/features/transactions/`, `lib/core/data/database.dart`, `docs/`.
- Контекст/ограничения: offline-first, Drift миграции обязательны; автоген не править; UI минимум логики в `build`; использовать `select()` где уместно.
- Риски: неконсистентные балансы счетов; утечка скрытых категорий в фильтрах/аналитике; миграция категории.

## Interfaces and Dependencies
- Внешние сервисы (Firebase/Analytics/Crashlytics): Firestore синк категорий/кредитов/транзакций.
- Локальные зависимости (Drift, codegen): миграция таблицы `Categories`, обновление маппинга сущностей, `build_runner`.
- Затрагиваемые API/модули: `AddCreditUseCase`, `AddEditCreditScreen`, категории (watch/list), форма транзакции (dropdown категорий).

## Plan of Work
- Спроектировать UX/данные выдачи кредита и источник отрицательного баланса.
- Добавить признак скрытой категории и фильтрацию в нужных экранах.
- Обновить use cases/репозитории/мапперы и покрыть тестами.
- Обновить документацию по поведению кредитов и категорий.

## Concrete Steps
1) Проанализировать текущий флоу создания кредита (`AddEditCreditScreen`, `AddCreditUseCase`) и точки расчета балансов; определить, как формируется отрицательный баланс (транзакция перевода vs. начальный баланс) и как использовать `targetAccountId`.
2) UI создания кредита:
   - добавить переключатель «Кредит уже выдан»;
   - добавить выбор счета для зачисления (список счетов, исключая `type == 'credit'`), с пустым состоянием;
   - определить правила: если выбран счет — создаем перевод; если отмечено «уже выдан» без счета — создаем отрицательный баланс на кредитном счете.
3) Доменная логика:
   - расширить `AddCreditUseCase` параметрами `isIssued` и `issueAccountId` (или переиспользовать `targetAccountId`), определить приоритеты;
   - при `issueAccountId != null` создавать перевод на счет получателя (как сейчас);
   - при `isIssued == true` и без целевого счета — выставлять отрицательный стартовый баланс/открывающий баланс кредитного счета (через `AccountRepository` или системную транзакцию).
4) Скрытые категории для кредитов:
   - добавить поле `isHidden` в таблицу `Categories` (Drift миграция) и в `Category` (Freezed);
   - при создании кредитных категорий устанавливать `isHidden = true` (основная, проценты, комиссии);
   - обновить маппинг DAO/репозиториев и синк с Firebase.
5) Фильтрация отображения:
   - `ManageCategoriesScreen`: исключить скрытые категории из дерева/списка;
   - `transactionFormCategoriesProvider` и UI формы транзакций: исключить скрытые категории;
   - проверить влияние на фильтры/аналитику/прочие списки категорий и при необходимости локально фильтровать.
6) Тесты:
   - unit-тесты `AddCreditUseCase`: перевод на выбранный счет, отрицательный баланс при `isIssued` без счета;
   - unit/widget-тесты фильтрации категорий (скрытые не отображаются в категории и форме транзакции).
7) Документация:
   - обновить `docs/logic/feature_invariants.md` или профильный документ о кредитах;
   - добавить описание скрытых кредитных категорий и правил выдачи кредита.

## Validation and Acceptance
- Команды проверки:
```bash
flutter pub get
dart run build_runner build --delete-conflicting-outputs
dart format --set-exit-if-changed .
flutter analyze
flutter test --reporter expanded
```
- Acceptance criteria:
  - При создании кредита можно выбрать счет зачисления или отметить «кредит уже выдан».
  - Кредитный счет имеет отрицательный баланс после выдачи (через перевод или стартовый баланс).
  - Созданные кредитные категории скрыты в `ManageCategoriesScreen` и в форме добавления/редактирования транзакций.
  - Синк/схема Drift проходят без ошибок.

## Idempotence and Recovery
- Что можно безопасно перезапускать: `build_runner`, форматирование, анализ, тесты, миграции в dev.
- Как откатиться/восстановиться: удалить новые поля/фильтры и миграцию, вернуть предыдущий флоу выдачи кредита.
- План rollback (для миграций): оставить `isHidden` nullable/false по умолчанию; при откате — игнорировать поле в маппинге.

## Progress
- [ ] Шаг 1: Анализ текущего флоу и правил баланса.
- [ ] Шаг 2: UI выдачи кредита (переключатель + выбор счета).
- [ ] Шаг 3: Логика `AddCreditUseCase` для выдачи/отрицательного баланса.
- [ ] Шаг 4: `isHidden` в категориях + миграция.
- [ ] Шаг 5: Фильтрация в экранах категорий и форме транзакций.
- [ ] Шаг 6: Тесты.
- [ ] Шаг 7: Документация.

## Surprises & Discoveries
- ...

## Decision Log
- ...

## Outcomes & Retrospective
- Что сделано:
- Что бы улучшить в следующий раз:

## Definition of Done (чек-лист)

- `dart format --set-exit-if-changed .` без изменений.
- `flutter analyze` без ошибок.
- `dart run build_runner build --delete-conflicting-outputs` проходит.
- `flutter test --reporter expanded` проходит.
- Новая логика покрыта unit-тестами и хотя бы одним widget или integration тестом.
- Нет тяжелого CPU/I/O на UI isolate.
- Для изменений производительности — есть измерение до/после.

## Regression checklist

- Riverpod: минимизированы лишние rebuild, использованы `.select()`/листовые `ConsumerWidget`.
- Freezed: модели и состояния immutable, корректная генерация.
- Drift: миграции добавлены и протестированы, схема не правится вручную.
- Offline-first: запись сначала в локальную БД.
- Sync: конфликт-стратегия ясна, upsert идемпотентен.
- UI: списки оптимизированы (`itemExtent`/`prototypeItem`), форматтеры кэшированы.
- Ошибки/сеть: корректные offline/syncing/up-to-date состояния.

## Документация

- Любое изменение поведения → обновить `docs/`.
- Миграции/схемы → описать в `docs/logic/` (отдельный документ или обновление существующего).
- Изменения UX → `docs/components/` или `docs/logic/` с описанием поведения.
- Минимальный формат записи:
  - Что изменилось
  - Зачем
  - Как проверить
  - Breaking changes (если есть)
