# ExecPlan: Учет платежей по кредиту (транзакции + дата следующего платежа)

## Context and Orientation
- Цель: чтобы платеж по кредиту отображался в транзакциях кредитного счёта и сдвигал дату следующего платежа.
- Область кода: транзакции (use cases/репозиторий), кредиты (credit/category связь), upcoming payments (правила и пересчёт дат).
- Контекст/ограничения: без правки автоген‑файлов; offline‑first; изменения должны быть идемпотентными.
- Риски: дублирование транзакций в списках, неверный сдвиг даты при редактировании/удалении, регресс фильтров аккаунта.

## Interfaces and Dependencies
- Внешние сервисы (Firebase/Analytics/Crashlytics): синк upcoming payments и accounts через outbox.
- Локальные зависимости (Drift, codegen): возможны новые DAO‑запросы по категории/аккаунту; без миграций, если не вводим новые поля.
- Затрагиваемые API/модули: `WatchAccountTransactionsUseCase`, `TransactionRepositoryImpl`, `UpcomingPaymentsRepository`, `SchedulePolicy`, `CreditDao`.

## Plan of Work
- Зафиксировать правила: кредитный платеж = транзакция с категорией кредита.
- Добавить отображение таких транзакций в списке кредитного счёта (без дублирования сущностей).
- Обновить дату следующего платежа на основании факта оплаты.
- Покрыть поведение тестами и обновить документацию.

## Concrete Steps
1) Инвентаризация: определить правило “кредитный платеж = expense с категорией кредита”, связать `categoryId → credit.accountId`.
2) Реализовать включение таких транзакций в `WatchAccountTransactionsUseCase` для кредитного счёта (без создания зеркальной транзакции).
3) Добавить пересчёт `nextRunAtMs` для upcoming payment по кредиту после add/update/delete транзакции: база пересчёта = дата платежа, переход на следующий месяц.
4) Добавить DAO/репозиторный запрос для поиска upcoming payment по `categoryId` и поиска последнего платежа по этой категории (для отката даты при delete).
5) Добавить unit‑тесты: показ платежа в кредитном счёте, сдвиг даты после оплаты, откат даты после delete, корректный пересчет после update.
6) Обновить `docs/logic/feature_invariants.md` (кредиты/платежи/транзакции счетов).

## Validation and Acceptance
- Команды проверки:
```bash
dart format --set-exit-if-changed .
flutter analyze
dart run build_runner build --delete-conflicting-outputs
flutter test --reporter expanded
```
- Acceptance criteria:
  - Платеж по кредиту отображается в транзакциях кредитного счета без дубликатов.
  - Дата следующего платежа обновляется после успешного платежа на следующий месяц.
  - Редактирование/удаление платежа корректно пересчитывает дату следующего платежа (с откатом при delete).

## Idempotence and Recovery
- Что можно безопасно перезапускать: тесты, форматирование, analyze, build_runner.
- Как откатиться/восстановиться: вернуть фильтрацию транзакций счета к текущей логике; отключить пересчёт `nextRunAtMs`.
- План rollback (для миграций): миграции не требуются; откат по git.

## Progress
- [x] Шаг 1: Инвентаризация текущей логики.
- [x] Шаг 2: Отображение платежей по кредиту в транзакциях кредитного счета.
- [x] Шаг 3: Пересчёт даты следующего платежа.
- [x] Шаг 4: DAO/репозиторные запросы (использован `loadTransactions()` и `watchAll()` вместо новых DAO).
- [x] Шаг 5: Тесты.
- [x] Шаг 6: Документация.

## Surprises & Discoveries
- `SchedulePolicy.computeNextRunLocal` при раннем платеже оставляет дату в текущем месяце, поэтому для кредитов нужен расчёт «следующий месяц» вручную.

## Decision Log
- ...

## Outcomes & Retrospective
- Что сделано:
- Что бы улучшить в следующий раз:
