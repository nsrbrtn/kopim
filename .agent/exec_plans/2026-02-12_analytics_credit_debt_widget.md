# ExecPlan: Виджет операций по кредитам и долгам в аналитике

## Context and Orientation
- Цель: добавить на экран аналитики блок под круговой диаграммой, который показывает операции по кредитам и долгам за выбранный период.
- Область кода: `lib/features/analytics/presentation/analytics_screen.dart`, `lib/features/analytics/presentation/controllers/analytics_providers.dart`, документация `docs/components/`.
- Контекст/ограничения: визуальный стиль должен совпадать с текущими карточками аналитики; учитывать текущие фильтры периода/счетов; не включать погашение тела в потребительские расходы.
- Риски: неоднозначная классификация некоторых переводов (между долг/кредит-счетами), нагрузка при фильтрации потока транзакций.

## Interfaces and Dependencies
- Внешние сервисы (Firebase/Analytics/Crashlytics): нет.
- Локальные зависимости (Drift, codegen): кодоген не требуется при использовании обычных `StreamProvider`.
- Затрагиваемые API/модули: `watchRecentTransactionsUseCaseProvider`, `watchCreditsUseCaseProvider`, фильтры аналитики.

## Plan of Work
- Добавить вычисление кредитно-долговых операций в `analytics_providers` с учетом фильтров периода/счетов.
- Добавить UI-виджет под диаграммой в табе категорий (карточка с итогами и списком операций).
- Обновить документацию по компонентам аналитики.

## Concrete Steps
1) Реализовать доменную модель/агрегацию для блока (тело, обслуживание, список операций).
2) Встроить новый виджет в `_TopCategoriesPage` под donut chart и легендой.
3) Прогнать форматирование и анализ, обновить docs.

## Validation and Acceptance
- Команды проверки:
```bash
dart format --set-exit-if-changed lib/features/analytics/presentation/controllers/analytics_providers.dart lib/features/analytics/presentation/analytics_screen.dart docs/components/analytics_credit_debt_operations_widget.md
flutter analyze
```
- Acceptance criteria:
  - На вкладке категорий под диаграммой отображается блок операций по кредитам/долгам.
  - Блок учитывает выбранный период и фильтр счетов.
  - Погашение тела выделено отдельно от расходов на обслуживание (проценты/комиссии).

## Idempotence and Recovery
- Что можно безопасно перезапускать: `dart format`, `flutter analyze`.
- Как откатиться/восстановиться: удалить добавленный виджет/провайдер и вернуть экран к прежнему состоянию.
- План rollback (для миграций): не требуется.

## Progress
- [x] Шаг 1: Реализовать агрегацию операций в провайдерах.
- [x] Шаг 2: Добавить и встроить UI-виджет в экран аналитики.
- [x] Шаг 3: Обновить документацию и выполнить проверки.

## Surprises & Discoveries
- Для корректного отделения обслуживания долга использована привязка к `interestCategoryId` и `feesCategoryId` из сущности кредита.
- Для учета переводов в/из долг-счетов отбор операций выполнен по счетам типов `credit`, `credit_card`, `debt`.

## Decision Log
- Выбран отдельный блок под диаграммой только на вкладке расходов, чтобы не смешивать его с вкладкой доходов.
- Погашение тела и проценты/комиссии считаются раздельно; в итоговый отток включены только эти два компонента.

## Outcomes & Retrospective
- Что сделано:
- Добавлен `analyticsCreditDebtOperationsProvider` и модель сводки `CreditDebtOperationsOverview`.
- Добавлен UI-блок `Операции по кредитам и долгам` под диаграммой категорий.
- Добавлена документация компонента в `docs/components/AnalyticsCreditDebtOperationsWidget.md`.
- Что бы улучшить в следующий раз:
- Добавить расширенную классификацию для долговых операций, не связанных с кредитными сервисными категориями.
