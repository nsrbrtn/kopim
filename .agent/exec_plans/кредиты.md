# Критичные и важные находки

## Статус критичной проблемы

Статус: ✅ Исправлено

Исправлено: редактирование кредита больше не перезаписывает текущий баланс кредитного счёта через `-totalAmount`.

Что сделано:
- Удалено принудительное присвоение `balanceMinor: -resolvedAmount.minor` в `UpdateCreditUseCase`.
- При редактировании кредита сохраняется фактический баланс счёта, накопленный транзакциями.

Файл:
- `lib/features/credits/domain/use_cases/update_credit_use_case.dart`

## Найденные пункты

Незакрытых пунктов в этом списке на текущий момент нет.

Статус: ✅ Исправлено
Высокий: дата первого платежа при создании кредита рассчитывается через DateTime(year, month + 1, paymentDay) без ограничения дня по длине месяца. Для paymentDay=31 и коротких месяцев дата уедет в следующий месяц (например, на март вместо февраля).
add_edit_credit_screen.dart (line 153)
add_edit_credit_screen.dart (line 208)

Статус: ✅ Исправлено
Высокий: проведение платежа по кредиту не атомарно. Последовательно пишутся: обновление графика, группа платежа, затем 1-3 транзакции. При ошибке посередине остаётся частично записанное состояние (рассинхрон графика/группы/транзакций).
make_credit_payment_use_case.dart (line 55)
make_credit_payment_use_case.dart (line 98)
make_credit_payment_use_case.dart (line 115)
make_credit_payment_use_case.dart (line 134)
make_credit_payment_use_case.dart (line 153)
make_credit_payment_use_case.dart (line 172)

Статус: ✅ Исправлено
Средний: можно отправить платёж с нулевыми суммами, и use case всё равно создаст payment group (без транзакций), что засоряет историю и может путать аналитику. Валидации “хотя бы одна сумма > 0” нет.
pay_credit_sheet.dart (line 285)
pay_credit_sheet.dart (line 291)
make_credit_payment_use_case.dart (line 101)

Статус: ✅ Исправлено
Средний: экран кредита теперь подписывается на полный поток всех транзакций и фильтрует их на клиенте. На больших объёмах будет лишняя нагрузка и возможные фризы.
credit_details_screen.dart (line 56)
all_transactions_providers.dart (line 14)

Статус: ✅ Исправлено
Средний: при удалении кредита удаляются кредит/счёт/категории, но нет явной очистки графика платежей, групп платежей и связанных recurring-правил. Риск “осиротевших” данных.
delete_credit_use_case.dart (line 17)
delete_credit_use_case.dart (line 35)
credit_repository_impl.dart (line 125)
credit_repository_impl.dart (line 145)

Статус: ✅ Исправлено
Низкий: непоследовательность в нейминге категорий кредита при add/update. При создании главная категория называется как name, при обновлении — Кредит: name; также не переименовываются interest/fees категории. Это создаёт визуальную и логическую неоднородность.
add_credit_use_case.dart (line 66)
update_credit_use_case.dart (line 108)
