# Идемпотентность автоплатежей (Upcoming)

## Цель
Исключить дубли автоплатежей при повторных запусках фоновой задачи, смене часового пояса или длительном отсутствии запуска приложения.

## Основные принципы
- **Идемпотентность на двух уровнях**:
  - `UpcomingPayment.lastGeneratedPeriod` — фиксирует, за какой период автоплатеж уже был создан.
  - `Transaction.idempotencyKey` — уникальный ключ автоплатежа на дату исполнения.
- **Источник истины**: локальная БД (Drift). Синхронизация с Firebase переносит ключи для единообразного поведения.

## Формат ключей
- `lastGeneratedPeriod`: `YYYY-MM` (локальная дата due)
- `idempotencyKey`: `upcoming:<paymentId>:YYYY-MM-DD` (локальная дата due)

## Алгоритм автопостинга
1) Если `nextRunAtMs <= now` и `autoPost == true`:
   - вычислить `dueLocal` из `nextRunAtMs` в локальной TZ;
   - сформировать `periodKey` и `idempotencyKey`.
2) Если `lastGeneratedPeriod == periodKey` → пропустить создание.
3) Иначе проверить, есть ли транзакция с `idempotencyKey`.
4) Если нет — создать транзакцию с этим ключом.
5) После успешного создания или обнаружения существующей транзакции — записать `lastGeneratedPeriod`.
6) Затем пересчитать `nextRunAtMs` по политике расписания.

## Поведение в крайних случаях
- **Повторный запуск WorkManager**: транзакция уже существует → пропуск.
- **Смена часового пояса**: `idempotencyKey` привязан к локальной due-дате → предотвращает дубль.
- **Простой приложения**: при catch-up создается не более одной транзакции на период.

## Ограничения
- `idempotencyKey` уникален в таблице `transactions`.
- Если автоплатеж был создан и затем удален, повторная генерация для той же даты не выполняется (ключ остается уникальным).

## Как проверить
1) Создать автоплатеж с `autoPost = true`.
2) Симулировать повторный запуск фоновой задачи с той же датой.
3) Убедиться, что создана ровно одна транзакция.
4) Проверить, что `lastGeneratedPeriod` обновлен.
