# Инструменты ИИ-ассистента (Tool Use)

## Назначение
Инструменты позволяют ассистенту запрашивать конкретные данные из локальной БД
вместо жёстких RegEx-фильтров. Это делает ответы гибче и точнее, сохраняя
offline-first подход (данные только из Drift, без Firebase).

## Общий поток
1. Модель получает вопрос пользователя и список доступных инструментов.
2. При необходимости модель вызывает инструменты (tool calls).
3. Приложение исполняет инструменты локально и возвращает результаты.
4. Модель формирует финальный ответ на основе результатов.
5. Если tool calls отсутствуют или произошла ошибка — используется фоллбек
   на текущую сводку `AiFinancialOverview`.

## Инструменты v1
### 1) get_spending_summary
- Назначение: сумма расходов по валютам за период.
- Параметры: `period`, `start_date`, `end_date`, `category_ids`, `account_ids`.
- Ограничения: максимум 180 дней.

### 2) get_income_summary
- Назначение: сумма доходов по валютам за период.
- Параметры: `period`, `start_date`, `end_date`, `category_ids`, `account_ids`.
- Ограничения: максимум 180 дней.

### 3) get_top_categories
- Назначение: топ категорий по сумме за период.
- Параметры: `type` (expense|income), `period`, `start_date`, `end_date`,
  `limit`, `account_ids`.
- Ограничения: limit до 10, максимум 180 дней.

### 4) get_transactions
- Назначение: список транзакций с деталями.
- Параметры: `period`, `start_date`, `end_date`, `category_ids`, `account_ids`,
  `transaction_type`, `limit`.
- Ограничения: limit до 200, максимум 180 дней.

### 5) find_categories
- Назначение: поиск категорий по названию.
- Параметры: `query`, `limit`.
- Ограничения: limit до 20.

### 6) find_accounts
- Назначение: поиск счетов по названию.
- Параметры: `query`, `limit`.
- Ограничения: limit до 20.

## Периоды
Поддерживаемые значения `period`:
- `current_month`, `month_to_date`
- `last_month`
- `last_30_days`, `last_90_days`
- `last_week`, `week_to_date`
- `year_to_date`

Если указаны `start_date` и `end_date`, поле `period` игнорируется.

## Лимиты и безопасность
- Максимальный диапазон: 180 дней (лишнее обрезается).
- Максимум транзакций за один вызов: 200.
- Инструменты читают только локальные данные (Drift).
- Идентифицирующие данные пользователя не возвращаются.

## Логи и аналитика
- `ai_tool_call` — запись каждого вызова инструмента.
- `ai_assistant_answer` — итоговый ответ с признаком использования инструментов.

## Ссылки на код
- Реестр инструментов: `lib/features/ai/data/tools/ai_assistant_tools.dart`
- Роутер инструментов: `lib/features/ai/data/tools/ai_assistant_tool_router.dart`
- DAO для инструментов: `lib/features/ai/data/local/ai_assistant_tool_dao.dart`
