# Инварианты и правила по фичам

Этот документ фиксирует доменные инварианты и требования по ключевым фичам.

## Accounts (Счета)

Сущность: `Account { id, name, balance, currency, type }` (Freezed).

Структура:

- Интерфейсы репозиториев — в `domain/`.
- Drift DAO — в `data/local/`.
- Firebase-адаптер — в `data/remote/`.

Инварианты:

- `balance` соответствует сумме транзакций по счёту (или согласован с доменной логикой).

UI:

- Экран списка счетов: фиксированная высота строк; форматирование сумм и валют кэшируется; `.select()` на уровне листовых виджетов.
- Детальный экран счёта — не ломать инварианты баланса при ручных операциях.

## Transactions (Транзакции)

Сущность: `Transaction { id, accountId, categoryId, amount, date, note, type }`.

Инварианты:

- `amount > 0` (знак задаётся через `type` или отдельное поле).
- `accountId` и `categoryId` ссылаются на существующие записи.
- Дебет/кредит-логика корректна (не переворачивать знаки без необходимости).

Операции в БД:

- Вставка/обновление транзакции — в рамках одной DB-транзакции:
  - обновляет запись транзакции;
  - обновляет `balance` соответствующего счёта;
  - при необходимости, обновляет агрегаты аналитики.

Дом/лента:

- Для домашнего фида и длинных списков:
  - `itemExtent` или `prototypeItem`;
  - листовые `ConsumerWidget` с `.select()`;
  - кэшированные `DateFormat` / `NumberFormat`.

## Categories (Категории)

Сущность: `Category { id, name, type, icon, color }`.

Инварианты:

- `type` может определять расход/доход/другое.

Иконки:

- Используется ограниченный, курируемый набор.
- Никаких runtime-поисков по тысячам иконок в горячих путях.

Связи:

- Категории привязаны к транзакциям и аналитике; удаление требует миграционной стратегии (soft delete, remap и т.п.).

## Analytics (Аналитика)

Агрегации:

- Запросы (суммы по категориям/периодам/счетам) — в Drift.
- Выполнение — вне UI isolate.

UI:

- Графики/диаграммы работают с подготовленными DTO.
- Не делать сложные вычисления внутри `build`.

Тесты:

- Юнит-тесты для агрегаций с edge-cases: нулевые периоды, без категорий, много валют.

## Auth / Profile (Профиль и вход)

Firebase:

- Инициализацию Firebase делать после первого кадра (не блокировать старт UI).

UI:

- Пока Firebase не готов — показывать скелетон/экран загрузки.

Синк:

- При входе — запуск логики синхронизации локальных данных с облаком.

Performance:

- Firebase Performance — кастомные трейсы вокруг логики входа и первой загрузки данных.

## Budgets (Бюджеты)

Модель:

- Бюджеты по категориям или общие.
- Поля: лимит, период, привязка к категориям/счетам, статус.

Логика:

- Расчёт выполнения бюджета через запросы Drift (сумма расходов за период).
- Инварианты: бюджет не уходит в неконсистентные состояния.

Тесты:

- Юнит-тесты для краевых случаев: пересечение периодов; изменения бюджета в середине периода.

## Recurring Transactions (Повторяющиеся транзакции)

Модель:

- RRULE-подобные поля (тип повторения, интервал, дата начала/конца).
- Флаг pause/resume.

Логика:

- Детерминированный расчёт следующего срабатывания.
- Генерация транзакции по расписанию не должна дублировать запись (идемпотентность).

Тесты:

- Интеграционные тесты с «time travel» (моки времени).

## AI Financial Assistant (ИИ-финансовый ассистент)

Доступ к данным:

- Только через локальный сервис, читающий Drift.
- Без прямых запросов к Firebase из ассистента.

Конфиденциальность:

- Не отдавать идентифицирующие данные пользователя.
- Аггрегированные ответы: «сколько потратил на X в этом месяце», «топ категорий расходов».

Функциональность:

- Простые вопросы: «Сколько я потратил на еду в этом месяце?», «Какие у меня самые большие расходы?»
- Ассистент не должен сам изменять данные — только читать и рекомендовать.
