# Технический аудит kopim

## 1) Метаданные
- Дата: 2026-01-18
- Ветка/коммит: master / ea80474a1852e5d50a33ad9f6dc4fa207748ccad
- Окружение:
  - ОС: CachyOS 6.18.6-2-cachyos (locale ru_RU.UTF-8)
  - Flutter: 3.38.6 (stable)
  - Dart: 3.10.7
  - flutter doctor -v: есть предупреждение по Android лицензиям (нужно `flutter doctor --android-licenses`)

## 2) Команды и результаты
- `flutter --version` — OK
- `flutter doctor -v` — WARN: не приняты Android лицензии
- `dart --version` — OK
- `flutter pub get` — OK (49 пакетов с несовместимыми новыми версиями)
- `flutter pub run tool/figma_theme/generate_tokens.dart` — OK
- `dart run build_runner build --delete-conflicting-outputs` — OK
  - WARN: drift_dev `Duplicate orderings/filters` для `transactionsRefs` в `lib/core/data/database.dart`
- `dart format --set-exit-if-changed .` — FAIL
  - Фрагмент: `Formatted lib/core/theme/data/generated/kopim_theme_tokens.g.dart` (exit code 1)
- `flutter analyze` — FAIL
  - Фрагмент: `unnecessary_const` в `lib/features/profile/presentation/screens/sign_in_screen.dart:392:41`
- `flutter pub outdated` — OK (есть major/minor обновления)
- `flutter test --reporter expanded` — OK (полный прогон)
- `flutter build web` — OK с предупреждениями
  - Фрагмент: `Unexpected wasm dry run failure (252)` и предупреждение о недостающих шрифтах Phosphor
- `flutter build apk --debug` — FAIL
  - Фрагмент: `Gradle build failed to produce an .apk file` (APK фактически есть в `build/app/outputs/flutter-apk/`, см. раздел 4)

## 3) Сводка проблем (executive summary)
1) Критическая: баланс счетов пересчитывается дважды при создании/изменении транзакций и не пересчитывается при удалении через репозиторий — риск неверных остатков и ошибочной синхронизации.
2) Высокий риск рассинхронизации account.balance и фактических транзакций при merge (LWW) без пересчёта балансов.
3) Денежные значения хранятся как `double` без явной политики округления — риск накопления ошибок в транзакциях, аналитике и бюджетах.
4) Аналитика баланса и cashflow игнорируют переводы и целевой счёт перевода — отчёты по счетам могут быть неверны.
5) Исправлено: бюджеты пересчитывались по всем транзакциям в UI‑изоляте — риск фризов на Web/Android при больших объёмах данных.
6) Веб‑сборка выдаёт предупреждения о недостающих шрифтах (Phosphor) — потенциально отсутствующие иконки в Web.
7) Android build сообщает об отсутствии APK (при наличии артефактов) — проблемы с flavor/путями сборки.
8) Файл `upload-keystore.jks` в репозитории не найден — риск утечки ключей подписи снят.

**Риски для денег/расчётов:** неверные балансы и агрегаты (из‑за double и двойного применения дельт), неверная аналитика по счетам (переводы), рассинхрон при офлайн‑first (LWW без пересчёта).

**Статус (обновлено):**
- Пункты 1–2 и 4 — исправлены.
- Пункт 3 — закрыт: `double` удалён из доменных денег, остаётся только legacy/UI‑слой.
- Пункт 5 — закрыт: бюджеты переведены на SQL‑агрегации.
- Пункты 6–7 — актуальны.
- Пункт 8 — закрыт: файл `upload-keystore.jks` не найден в репозитории.

## 4) Полный список проблем (Markdown‑таблица)
| Severity | Где | Симптом | Почему это плохо | Как исправить | Как проверить | Сложность |
|---|---|---|---|---|---|---|
| Critical | `lib/features/transactions/domain/use_cases/add_transaction_use_case.dart:69` + `lib/features/transactions/domain/use_cases/update_transaction_use_case.dart:59` + `lib/features/transactions/data/repositories/transaction_repository_impl.dart:89` | Баланс счёта обновляется и в use case, и в репозитории | Двойное применение дельты → дрейф баланса, неверная синхронизация | Оставить один источник истины: либо баланс обновляет репозиторий, либо use case; удалить дублирование; привести логику удаления к симметрии | Создать/изменить транзакцию и проверить баланс ровно на 1 дельту | M |
| Critical | `lib/features/transactions/data/repositories/transaction_repository_impl.dart:115` + `lib/features/transactions/data/repositories/transaction_repository_impl.dart:210` | При `softDelete` баланс не пересчитывается (isDeleted отсекает дельту) | Если кто‑то вызывает репозиторий напрямую, баланс не меняется; несогласованность с create/update | Брать previous до `markDeleted` или игнорировать `isDeleted` при расчёте дельты удаления | Удалить транзакцию через репозиторий и проверить баланс | M |
| High | `lib/core/services/auth_sync_service.dart:560` + `lib/core/services/auth_sync_service.dart:848` | LWW merge аккаунтов без пересчёта балансов по транзакциям | Баланс может расходиться с merged транзакциями после синка | При синке пересчитывать account.balance из транзакций или хранить баланс как derived (не синкать) | Смоделировать конфликт: транзакции с обеих сторон, проверить баланс после sync | L |
| High | `lib/features/transactions/domain/entities/transaction.dart:16` + `lib/features/accounts/domain/entities/account_entity.dart:13` + `lib/features/budgets/domain/entities/budget.dart:21` | Деньги хранятся в `double` | Накопление ошибок округления в балансе/аналитике/бюджетах | Перейти на целые minor‑units (int) или Decimal; единая политика округления | Юнит‑тесты на суммирование/округление | L |
| High | `lib/features/analytics/presentation/controllers/analytics_providers.dart:183` + `lib/features/analytics/presentation/controllers/analytics_providers.dart:309` | Переводы игнорируются при расчётах баланса/кэшфлоу | Ошибка аналитики по выбранным счетам (особенно при переводах между счетами) | Учитывать transferAccountId и применять дельты к обоим счетам; задокументировать логику | Тест: перевод между счетами → корректная серия балансов | M |
| Medium | `lib/features/analytics/domain/use_cases/watch_monthly_analytics_use_case.dart:33` + `lib/features/analytics/presentation/controllers/analytics_providers.dart:153` | Вся аналитика считается в памяти по всем транзакциям | Потенциальные тормоза на Web/Android при большом объёме данных | Перенести агрегации в Drift/SQL или isolate; кэшировать | Профилинг больших наборов; сравнить FPS | M |
| Medium | `lib/features/budgets/presentation/controllers/budgets_providers.dart:41` | Пересчёт прогресса бюджета по всем транзакциям на каждый эмит | Высокая нагрузка при больших списках | Предфильтрация/батч‑агрегации; кэш; isolate | Профилинг в режиме 10k+ транзакций | M |
| Medium | `lib/features/transactions/data/repositories/transaction_repository_impl.dart:90` + `lib/features/transactions/domain/use_cases/add_transaction_use_case.dart:52` | Используются разные источники времени (UTC vs local) | В LWW merge может «побеждать» неактуальная запись | Нормализовать на UTC во всех слоях и при записи в БД | Тесты с одинаковыми updatedAt из разных TZ | S |
| Medium | `lib/features/transactions/domain/usecases/watch_recent_transactions_use_case.dart` + `lib/features/transactions/domain/use_cases/watch_recent_transactions_use_case.dart` | Дубликат use case в разных папках | Риск обращения к неправильной реализации, мёртвый код | Консолидировать в одну реализацию, удалить лишнее | flutter analyze, тесты | S |
| Medium | `pubspec.yaml` (неявно, по выводу build) | Web‑build предупреждает о недостающих шрифтах Phosphor | Возможные отсутствующие иконки в Web | Добавить семейства шрифтов или исправить IconData/uses-material-design | `flutter build web --no-wasm-dry-run`, визуальная проверка | S |
| Medium | `android/` (по сборке) | `flutter build apk --debug` не находит APK | Проблема сборки/CI, особенно с flavors | Документировать/использовать `--flavor` и корректный выходной путь | `flutter build apk --debug --flavor dev` | S |
| High | `upload-keystore.jks` (корень) | Наличие файла ключа подписи в репозитории | Риск компрометации ключа и перехвата подписей | Убедиться, что файл исключён из VCS, при необходимости — перевыпустить ключ | Проверка `.gitignore` и истории | M |
| Low | `lib/features/profile/presentation/screens/sign_in_screen.dart:392:41` | `unnecessary_const` | Шум в анализе | Удалить лишний `const` | `flutter analyze` | S |

## 4.1) Статус по пунктам (обновлено)
- Закрыто: двойной пересчёт баланса, `softDelete` баланс, LWW merge без пересчёта, учёт переводов в аналитике, переход с `double` на `minor/scale` в доменных деньгах.
- Закрыто: производительность аналитики (SQL‑агрегации для totals/cashflow/balance), производительность бюджетов (SQL‑агрегации расходов), `upload-keystore.jks` отсутствует, `unnecessary_const` не обнаружен.
- Закрыто: дубликат `watch_recent_transactions_use_case` удалён.
- Закрыто: предупреждения analyze по private types в `analytics_providers.dart` устранены.
- Открыто: UTC vs local, web‑шрифты Phosphor, Android APK/flavor.

## 5) Тесты
**Обновление:** `flutter test --reporter expanded` — OK (полный прогон).

**Исторические падения (исправлено):**
Все перечисленные ниже падения устранены.
1) `test/core/services/auth_sync_service_test.dart` — `AuthSyncService replays legacy category outbox payload with string icon descriptor`
   - Симптом: `Expected: <0> Actual: <1>`
   - Вероятная причина: нормализация outbox‑payload не применяется/дублируется.
   - Рекомендации: проверить `OutboxPayloadNormalizer`, входные данные legacy‑payload, стабилизировать ожидания.
   - Проверка: `flutter test test/core/services/auth_sync_service_test.dart`
2) `test/core/services/auth_sync_service_test.dart` — `AuthSyncService resets outbox entries when transaction fails`
   - Симптом: `CRITICAL SYNC ERROR: [cloud_firestore/unknown] boom` и падение
   - Вероятная причина: тест ожидает обработку исключения без проброса, а сервис логирует и пробрасывает.
   - Рекомендации: явно определить контракт (проглатывать/пробрасывать), обновить тест.
   - Проверка: `flutter test test/core/services/auth_sync_service_test.dart`
3) `test/features/accounts/presentation/controllers/add_account_form_controller_test.dart` — `submit surfaces error message when use case throws`
   - Симптом: `Expected: not null Actual: <null>`
   - Вероятная причина: контроллер не прокидывает ошибку в state.
   - Рекомендации: проверить обработку exception в контроллере.
   - Проверка: `flutter test test/features/accounts/presentation/controllers/add_account_form_controller_test.dart`
4) `test/features/ai/data/ai_assistant_repository_impl_test.dart` — `buildFilter ...`
   - Симптом: `registerFallbackValue` для `AiDataFilter` не зарегистрирован
   - Рекомендации: добавить `registerFallbackValue`/Fake для `AiDataFilter`.
   - Проверка: `flutter test test/features/ai/data/ai_assistant_repository_impl_test.dart`
5) `test/features/upcoming_payments/application/upcoming_notifications_controller_test.dart`
   - Симптом: `No matching calls` (verify called(0))
   - Рекомендации: заменить на `verifyNever` или исправить ожидания.
   - Проверка: `flutter test test/features/upcoming_payments/application/upcoming_notifications_controller_test.dart`
6) `test/features/upcoming_payments/domain/usecases/list_home_upcoming_items_uc_test.dart`
   - Симптом: `Expected: <2200> Actual: <3000>`
   - Рекомендации: проверить расчёт сортировки/лимита.
   - Проверка: `flutter test test/features/upcoming_payments/domain/usecases/list_home_upcoming_items_uc_test.dart`
7) `test/features/transactions/presentation/transaction_form_view_test.dart`
   - Симптом: `A Timer is still pending even after the widget tree was disposed`
   - Вероятная причина: не закрыт stream/timer (Drift/Riverpod) в тесте.
   - Рекомендации: корректно dispose providers/streams, использовать `pumpAndSettle`.
   - Проверка: `flutter test test/features/transactions/presentation/transaction_form_view_test.dart`
8) `test/features/transactions/presentation/controllers/transaction_form_controller_test.dart`
   - Симптом: стек с `LazyDatabase.ensureOpen`/`TransactionTagsDao.getLinksByTransaction`
   - Вероятная причина: неинициализированная база или мок в тесте.
   - Рекомендации: стабилизировать setup/DI, мокнуть DAO.
   - Проверка: `flutter test test/features/transactions/presentation/controllers/transaction_form_controller_test.dart`

**Рекомендации по тестам:**
- Добавить unit‑тесты на инварианты баланса (income/expense/transfer, delete/update), особенно для переводов.
- Добавить интеграционные тесты sync + outbox (слияние remote/local и сверка балансов).
- Добавить тесты аналитики по переводам и выбранным счетам.

## 6) Зависимости и устаревание
**Итоги `flutter pub outdated`:**
- Есть major‑обновления: `flutter_riverpod 3.2.0`, `riverpod 3.2.0`, `riverpod_annotation 4.x`, `riverpod_generator 4.x`, `syncfusion_flutter_* 32.x`, `timezone 0.11.0`, `sqlite3 3.1.3`.
- Minor/patch: `drift 2.30.1`, `build_runner 2.10.5`, `freezed 3.2.4`, `json_serializable 6.11.4`, `sentry_flutter 9.10.0` и др.

**Предложенный порядок обновлений:**
1) Patch/minor для Drift/Freezed/Json (низкий риск, быстрая выгода).
2) Riverpod‑стек (3.2/4.x) — проверить генерацию и provider‑API.
3) Syncfusion 32.x — проверить breaking changes в графиках.
4) sqlite3/timezone — проверить влияние на Web/Android.

**Потенциально неиспользуемые зависимости:**
- Требуется ручная проверка `pubspec.yaml` + `dart pub deps` (автоматически не подтверждено в этом прогоне).

## 7) Логика и доменные инварианты
**Транзакции:**
- Модель денег переведена на `minor/scale`; `double` остаётся как legacy/UI‑слой.
- Create/update/delete унифицированы, баланс derived и пересчитывается централизованно.

**Аналитика:**
- Агрегации по всем транзакциям на стороне UI → риск производительности.
- Учет переводов в балансах/кэшфлоу скорректирован.

**Бюджеты:**
- Прогресс рассчитывается по полному списку транзакций; при росте объёма возможны задержки.
- Риск расхождения прогресса при ошибочных балансах (см. транзакции).

**Офлайн‑first и синк:**
- LWW merge не гарантирует согласованность `account.balance` и транзакций.
- Нет явного «контракта» на пересчёт/валидность балансов при конфликте.

## 8) План работ (roadmap)
**Сначала сделать (0–3 дня):**
- Устранить двойной пересчёт баланса (транзакции vs репозиторий).
- Определить единую модель денег (int/Decimal) и стратегию округления.
- Привести логику sync к согласованным балансам (recompute или derived).

**Далее (1–2 недели):**
- Перенести тяжёлую аналитику в Drift/SQL или isolate.
- Исправить аналитические расчёты переводов.
- Стабилизировать тесты (особенно transaction_form/notifications/auth_sync).

**Потом (долгосрочно):**
- Миграции данных на minor‑units валют.
- Рефакторинг use cases/провайдеров с целью минимизации перерисовок.
- Обновление зависимостей до последних major (Riverpod/Syncfusion).

## 9) Отметки по выполнению
- 2026-01-18: баланс пересчитывается централизованно в data‑слое (use cases не правят баланс), добавлен unit‑тест на смену типа транзакции.
- 2026-01-18: добавлены unit‑тесты на инварианты баланса в `TransactionRepositoryImpl` (expense/transfer/credit/softDelete).
- 2026-01-18: тест `test/features/transactions/data/transaction_repository_impl_test.dart` пройден (все кейсы зелёные).
- 2026-01-18: завершена миграция модели денег: добавлены `Money` + `scale`, новые поля `amountMinor/balanceMinor` в доменных сущностях и документ `docs/logic/money_model.md`.
- 2026-01-18: добавлены колонки `*_minor` и `*_scale` в Drift (schemaVersion=32) и мапперы DAO для синхронизации double → minor.
- 2026-01-18: обновлены запросы Add/Update транзакций: поддержка `amountMinor/amountScale`, расчет scale по валюте счета.
- 2026-01-18: расширена схема Drift до `schemaVersion=33`: `amount_minor/amount_scale` для budgets и upcoming payments, добавлен backfill и обновлены мапперы DAO.
- 2026-01-18: расширена схема Drift до `schemaVersion=34`: `*_minor/*_scale` для debts/credits/credit_cards, добавлен backfill по валюте счета и обновлены DAO/репозитории.
- 2026-01-18: обновлены sync/import/export для модели money (payload/remote/CSV/JSON поддерживают `*_minor/*_scale`).
- 2026-01-18: добавлены тесты инвариантов money (MoneyAccumulator + аналитика на minor).
- 2026-01-18: добавлен пересчёт балансов после sync/import транзакций и unit‑тест импорта.
- 2026-01-18: внедрён opening balance (миграция `schemaVersion=31`), расчёт баланса теперь `openingBalance + сумма транзакций`; добавлена логика деривации openingBalance для legacy данных.
- 2026-01-18: экспорт/импорт CSV обновлён на поддержку `opening_balance` с безопасным fallback.
- 2026-01-18: пересчёт балансов перенесён в data‑слой (единый helper), use cases больше не правят баланс; sync/import/взносы используют общую логику с учётом кредитов и переводов.
- 2026-01-18: миграции и backfill для `*_minor/*_scale` завершены (accounts/transactions/budgets/upcoming/debts/credits/credit_cards, `schemaVersion=34`).
- 2026-01-18: стабилизация тестов sync/transactions завершена; полный прогон `flutter test --reporter expanded` — зелёный.
- 2026-01-18: `double` удалён из доменных моделей денег (включая AI‑агрегации и monthly totals), добавлены JSON‑конвертеры для MoneyAmount и обновлены тесты.
- 2026-01-18: `MonthlyBalanceData` и `AccountTransactionSummary` переведены на `MoneyAmount`; UI‑графики и summary форматируют через `toDouble()`.
- 2026-01-18: предупреждения analyze по `library_private_types_in_public_api` в аналитике устранены (публичные окна дат/месяцев).

## 10) Обход use cases при записи транзакций (добавлено)
- `lib/core/services/auth_sync_service.dart:765` — запись `TransactionDao.upsertAll` при sync.  
  Исправление: пересчёт балансов выполняется через общий helper, учитывает переводы и кредитные категории.  
  Примечание: баланс считается как `openingBalance + сумма транзакций`.
- `lib/features/settings/data/repositories/import_data_repository_impl.dart:35` — запись `TransactionDao.upsertAll` при импорте.  
  Исправление: пересчёт балансов после импорта выполняется через общий helper + unit‑тест.  
  Примечание: используется openingBalance + сумма транзакций; для legacy данных openingBalance деривируется из текущего balance.
- `lib/core/services/auth_sync_service.dart:854` — пересчёт баланса при sync.  
  Примечание: используется openingBalance + сумма транзакций; openingBalance деривируется, если отсутствует или равен текущему balance при наличии транзакций.
- `lib/features/savings/data/repositories/saving_goal_repository_impl.dart:226` — запись `TransactionDao.upsert` при взносах.  
  Риск снижен: баланс пересчитывается через общий helper, логика едина с остальными путями.

## 11) Инвентаризация аналитики и метрик (шаг 1)
**Где считаются суммы и агрегации:**
- `lib/features/analytics/domain/use_cases/watch_monthly_analytics_use_case.dart` — in‑memory агрегация `AnalyticsOverview` на основе итогов по категориям: фильтр по датам/счетам/категориям, разбор иерархии категорий, сводные суммы доход/расход, top‑категории + "прочие".
- `lib/features/analytics/presentation/controllers/analytics_providers.dart` — сбор витрин для UI:
  - `analyticsFilteredStatsProvider` → поток `AnalyticsOverview`.
  - `analyticsCategoryTransactionsProvider` → список транзакций по категории/типу.
  - `monthlyBalanceData` → 6 месяцев, суммирование `maxBalance` в памяти.
  - `monthlyCashflowDataProvider` → 12 месяцев, сбор `income/expense` в памяти.
- `lib/features/transactions/data/sources/local/transaction_dao.dart` — SQL‑агрегации:
  - `watchAnalyticsCategoryTotals` — сумма по категориям и scale, фильтры по периоду и счетам.
  - `watchMonthlyCashflowTotals` — cashflow с учетом переводов и выбранных счетов.
  - `watchMonthlyBalanceTotals` — max‑баланс по месяцам, окно по датам, opening balance и дельты.
  - `watchCategoryTransactions` — выборка транзакций по категории/типу/счетам.

**Фильтры и группировки:**
- Период: `AnalyticsFilter` с start/end (месяц/период), в UI задаётся `AnalyticsFilterController`.
- Счета: одиночный `accountId` или список `accountIds` (в аналитике используются оба варианта).
- Категории: `categoryId` + флаг `includeSubcategories`, фильтр исключает удалённые категории.
- Переводы: учтены в SQL для cashflow и monthly balance (дельты по выбранным счетам).

**Метрики производительности (текущее состояние):**
- Явные метрики/замеры отсутствуют (нет таймингов, логирования или бенчмарков).
- Контрольные точки для будущих измерений: время до первого значения потоков `analyticsFilteredStatsProvider`, `monthlyBalanceData`, `monthlyCashflowDataProvider` на наборе 10k+ транзакций.

## 12) Проектирование SQL-агрегаций для аналитики (шаг 2, завершено)
**Исходные ограничения:**
- Глубина категорий максимум 2 уровня (root + child), см. `SaveCategoryUseCase`.
- Переводы должны учитываться для cashflow/балансов по выбранным счетам.
- Денежные значения — `amount_minor/amount_scale` (sum по minor, scale берется из транзакции).

**Предлагаемые SQL-агрегации (Drift/SQLite):**
1) **Итоги по категориям (для `AnalyticsOverview` + топ-категорий)**  
   Цель: получить суммы по категориям и по root-уровню, чтобы минимизировать агрегацию в памяти.
   - Базовый фильтр: `is_deleted=0`, `date>=start`, `date<end`, `type IN (income, expense)`.
   - Фильтр по счетам: `account_id IN (...)` или `account_id = ?`.
   - Фильтр по категории:
     - `includeSubcategories=true`: `category_id = :catId OR c.parent_id = :catId`.
     - `includeSubcategories=false`: `category_id = :catId`.
   - Группировка:
     - `category_id` (raw, для детей/листов),
     - `root_category_id` = `CASE WHEN c.parent_id IS NULL THEN c.id ELSE c.parent_id END`,
     - `amount_scale`.
   - Пример каркаса:
     - `WITH base AS (...) SELECT category_id, root_category_id, amount_scale, SUM(income_minor), SUM(expense_minor) ... GROUP BY category_id, root_category_id, amount_scale`.
   - Выход: два представления — raw по `category_id` и агрегаты по `root_category_id` (можно одним запросом и последующей сборкой в памяти).

2) **Топ-категории (N + "прочие")**  
   Цель: вынести сортировку/лимит в SQL.
   - На основе агрегатов по `root_category_id` для расходов и доходов.
   - `ORDER BY expense_minor DESC LIMIT :N`, остаток складывается в "прочие".
   - Примечание: "прочие" лучше собирать в памяти, чтобы сохранить дерево и children.

3) **Cashflow по месяцам (12 мес, с переводами)**  
   Уже реализовано в `watchMonthlyCashflowTotals`; SQL подходит для переноса логики из UI.
   - Для выбранных счетов: отдельные ветки CASE для transfer (вход/выход).
   - Группировка: `strftime('%Y-%m', date, 'unixepoch')`, `amount_scale`.

4) **Monthly balance (max balance в месяце)**  
   Уже реализовано в `watchMonthlyBalanceTotals`; SQL использует `opening_balance` + delta и window.
   - Важно: хранить `month_start` в CTE для нужного интервала (6 месяцев).

5) **Транзакции по категории для drill-down**  
   `watchCategoryTransactions` уже на SQL; корректно фильтрует по счетам/типу/категории.

**Индексация (согласовано):**
- Оставить существующий `transactions_date_account_category_idx` (`date, account_id, category_id`).
- Добавить `transactions_account_date_type_idx` (`account_id, date, type`).
- Добавить `transactions_category_date_idx` (`category_id, date`).
- Добавить `transactions_transfer_account_idx` (`transfer_account_id`).
- Добавить `categories_parent_idx` (`parent_id`) для связей root/child.

**Дельта к текущему состоянию:**
- SQL для cashflow и monthly balance уже готов; для Overview нужна расширенная агрегация с root/child, чтобы убрать лишнюю работу в памяти.
